TESTES DE ACEITAÇÃO - PIPELINE DE MÍDIAS
========================================

## Pré-requisitos
- Bot configurado com token_status='validated'
- warmup_chat_id configurado (formato: -100XXXXXXXXXX)
- Bot é admin do canal de aquecimento
- ngrok rodando e webhook registrado

## Teste A: Upload → Warmup → File ID Salvo → Preview Envia com File ID

1. Abra Admin → Config do Bot
2. Aba "Mensagem /start"
3. Clique "Adicionar mídia"
4. Selecione tipo: "Foto"
5. Selecione arquivo (qualquer imagem)
6. Clique "Salvar"

Esperado:
- ✓ Resposta: "Mídia adicionada e aquecida com sucesso!" ou "Mídia adicionada, mas warmup não foi possível"
- ✓ Logs backend: [MEDIA_UPLOAD] Recebido
- ✓ Logs backend: [MEDIA_RESOLVER] Iniciando resolução
- ✓ Se warmup_chat_id válido: [MEDIA_RESOLVER] Mídia resolvida com sucesso

7. Clique "Visualizar" (Preview)

Esperado:
- ✓ Resposta: "Preview enviado com sucesso para o grupo de aquecimento!"
- ✓ Logs backend: [PREVIEW:MEDIA:SEND] Enviando mídia 1
- ✓ Logs backend: [PREVIEW:MEDIA:OK] Mídia 1 enviada com sucesso
- ✓ Mensagem + mídia aparece no grupo de aquecimento

## Teste B: /start com 1-3 Mídias → Todas Enviadas

1. Configure 1-3 mídias no /start (Teste A)
2. Envie /start no Telegram para o bot

Esperado:
- ✓ Logs backend: [START:MEDIA_RESOLVE_START] mediasInConfig=N
- ✓ Logs backend: [MEDIA_RESOLVER] Completo: medias_resolved=N
- ✓ Logs backend: [MEDIA_RESOLVE] Iniciando resolução: medias_in_config=N
- ✓ Logs backend: [START:COMPLETE] mediaCount=N
- ✓ Usuário recebe mensagem + todas as mídias no Telegram

## Teste C: Sem warmup_chat_id → Erro Claro na UI

1. Remova warmup_chat_id do bot (ou deixe NULL)
2. Tente fazer upload de mídia

Esperado:
- ✓ Logs backend: [MEDIA_RESOLVER:WARMUP] warmup_chat_id não configurado
- ✓ Logs backend: [MEDIA_RESOLVER] Nenhuma mídia com file_id válido
- ✓ UI mostra: "Configurar warmup_chat_id e tornar o bot admin do canal"
- ✓ Preview falha com erro claro

## Teste D: Trocar Arquivo → Novo Warmup, Novo File ID

1. Configure 1 mídia no /start
2. Remova a mídia
3. Adicione outra mídia (arquivo diferente)
4. Clique Preview

Esperado:
- ✓ Novo media_key gerado
- ✓ Novo warmup executado
- ✓ Novo tg_file_id capturado
- ✓ Logs backend: [MEDIA_RESOLVER] Mídia resolvida com sucesso (novo file_id)
- ✓ Preview envia nova mídia com sucesso

## Teste E: Latência do Preview

1. Configure 1-3 mídias
2. Clique Preview
3. Observe tempo de resposta

Esperado:
- ✓ Primeira vez: até 3-5s (warmup + envio)
- ✓ Vezes seguintes: até 2-3s (file_id já em cache)
- ✓ Logs backend: latency_ms registrado

## Teste F: Erro 400 do Telegram - Logs Completos

1. Configure warmup_chat_id inválido (ex: 123 em vez de -100...)
2. Tente fazer upload de mídia
3. Verifique logs

Esperado:
- ✓ Logs backend: [PREVIEW:MEDIA:ERROR] status=400 body={...}
- ✓ Body contém mensagem de erro do Telegram (ex: "chat not found")
- ✓ UI mostra erro amigável

## Teste G: Múltiplos Bots - Isolamento de Mídias

1. Crie 2 bots
2. Configure mídias diferentes para cada um
3. Teste /start e preview para cada bot

Esperado:
- ✓ Cada bot tem suas próprias mídias em media_cache
- ✓ Índice único (bot_slug, kind, sha256) evita conflitos
- ✓ Logs backend: [MEDIA_RESOLVER] bot_slug diferente para cada bot

## Teste H: Degradação Sem Mídia

1. Configure /start com 1 mensagem + 1 mídia
2. Remova a mídia de media_cache (ou deixe sem file_id)
3. Envie /start

Esperado:
- ✓ Logs backend: [MEDIA_RESOLVE] Pulando mídia sem tg_file_id
- ✓ Usuário recebe mensagem (sem mídia)
- ✓ Sem erro 400 ou crash
- ✓ Fluxo degradado mas funcional

## Logs Esperados (Ordem Típica)

Para /start com 1 mídia:
1. [START:SEND_MESSAGE] botId=14, telegramId=123456
2. [START:MEDIA_RESOLVE_START] mediasInConfig=1
3. [MEDIA_RESOLVER] Iniciando resolução: bot_slug=vipshadriee_bot, medias_in_config=1
4. [MEDIA_RESOLVER] Mídia 0 resolvida com sucesso: kind=photo
5. [MEDIA_RESOLVER] Completo: medias_in_config=1, resolved=1, skipped=0, duration=XXXms
6. [START:MEDIA_RESOLVE_END] mediasResolved=1, mediasInConfig=1
7. [MEDIA_RESOLVE] Iniciando resolução: medias_in_config=1, messages=1
8. [MEDIA_RESOLVE] 1 mídias com file_id anexadas
9. [MEDIA_RESOLVE] Completo: payloads=1, medias_resolved=1, reasons_skipped=0
10. [START:PAYLOADS_READY] payloadCount=1, mediaCount=1
11. [START:TELEGRAM_SEND_START] payloadCount=1
12. [START:PAYLOAD_SENT] payloadIndex=1, success=true
13. [START:COMPLETE] sentCount=1, success=true, latencyMs=XXX

## Checklist de Validação

- [ ] Instrumentação completa com logs [MEDIA_RESOLVER], [MEDIA_RESOLVE], [PREVIEW:MEDIA]
- [ ] Nunca envia URL diretamente (só tg_file_id)
- [ ] Erro 400 do Telegram logado com body completo
- [ ] Shape canônico de mídia: { kind, key, caption }
- [ ] MediaResolver integrado no /start
- [ ] MediaResolver integrado no preview
- [ ] Índices em media_cache criados
- [ ] Warmup_chat_id validado (formato -100...)
- [ ] Degradação sem mídia funciona
- [ ] Múltiplos bots isolados
- [ ] Latência aceitável (≤ 3s primeira vez, ≤ 2s depois)
