<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Bots - Elysia</title>
  <link rel="stylesheet" href="/css/theme.css">
  <style>
    .navbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--card-border);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .navbar-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-brand a {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-primary);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .navbar-brand a:hover {
      color: var(--accent-secondary);
    }

    .navbar-links {
      display: flex;
      gap: 24px;
    }

    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 6px;
    }

    .nav-link:hover {
      color: var(--accent-primary);
    }

    .nav-link.active {
      color: var(--accent-primary);
      background: rgba(29, 205, 159, 0.1);
    }

    .page-wrapper {
      min-height: 100vh;
      padding: 40px 20px;
    }

    .page-header {
      margin-bottom: 40px;
    }

    .page-header-content {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 30px;
    }

    .page-header-info h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .page-header-info p {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .page-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .bots-container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .bots-header {
      padding: 24px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
    }

    .bots-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .bots-count {
      color: var(--text-tertiary);
      font-size: 13px;
    }

    .bots-table {
      width: 100%;
      border-collapse: collapse;
    }

    .bots-table thead {
      background: var(--bg-secondary);
    }

    .bots-table th {
      padding: 16px 20px;
      text-align: left;
      color: var(--text-tertiary);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--card-border);
    }

    .bots-table td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--card-border);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .bots-table tbody tr:hover {
      background: var(--bg-secondary);
    }

    .bot-name {
      font-weight: 600;
      color: var(--accent-primary);
    }

    .bot-actions {
      display: flex;
      gap: 8px;
    }

    .bot-actions button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .empty-state {
      padding: 80px 40px;
      text-align: center;
      color: var(--text-tertiary);
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 60px 40px;
      color: var(--text-tertiary);
    }

    .spinner {
      border: 3px solid rgba(29, 205, 159, 0.1);
      border-top: 3px solid var(--accent-primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #alerts {
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .navbar-links {
        gap: 12px;
      }

      .nav-link {
        padding: 6px 10px;
        font-size: 13px;
      }

      .page-wrapper {
        padding: 20px 12px;
      }

      .page-header-content {
        flex-direction: column;
      }

      .page-header-info h1 {
        font-size: 24px;
      }

      .page-controls {
        width: 100%;
      }

      .btn-pill {
        flex: 1;
        min-width: 100px;
      }

      .bots-table {
        font-size: 12px;
      }

      .bots-table th,
      .bots-table td {
        padding: 12px;
      }

      .bot-actions {
        flex-direction: column;
      }

      .bot-actions button {
        width: 100%;
      }

      .empty-state {
        padding: 40px 20px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container navbar-content">
      <div class="navbar-brand">
        <a href="/">ü§ñ Elysia</a>
      </div>
      <div class="navbar-links">
        <a href="/admin-bots.html" class="nav-link active">Dashboard</a>
        <a href="/" class="nav-link">Home</a>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="container">
      <div class="page-header">
        <div class="page-header-content">
          <div class="page-header-info">
            <h1>ü§ñ Dashboard de Bots</h1>
            <p>Gerencie seus bots Telegram de forma centralizada</p>
          </div>
          <button class="btn-primary" onclick="openCreateBotModal()" style="white-space: nowrap;">+ Novo Bot</button>
        </div>
        <div class="page-controls">
          <button id="filter-active" class="btn-pill active" onclick="loadBots(false)">Apenas Ativos</button>
          <button id="filter-inactive" class="btn-pill" onclick="loadBots(true)">Mostrar Inativos</button>
        </div>
      </div>

      <div id="alerts"></div>

      <div class="bots-container">
        <div class="bots-header">
          <h2>Bots Registrados</h2>
          <span class="bots-count" id="bot-count">Carregando...</span>
        </div>
        <div id="bots-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>Carregando bots...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Criar/Editar Bot -->
  <div id="botModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Novo Bot</h2>
        <button class="modal-close" onclick="closeBotModal()">√ó</button>
      </div>
      <form id="botForm" onsubmit="saveBotForm(event)">
        <div class="form-group">
          <label for="botSlug">Nome/Slug do Bot *</label>
          <input type="text" id="botSlug" name="slug" placeholder="ex: vipshadriee_bot" required>
          <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
            O slug ser√° normalizado automaticamente (lowercase, sem caracteres especiais)
          </small>
        </div>

        <div class="form-group">
          <label for="botProvider">Gateway de Pagamento</label>
          <select id="botProvider" name="provider">
            <option value="pushinpay">PushinPay</option>
            <option value="syncpay">SyncPay</option>
          </select>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="botActive" name="active" checked>
            <label for="botActive" style="margin: 0;">Ativo</label>
          </div>
        </div>

        <!-- Se√ß√£o preparada para futuras configura√ß√µes -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; color: #999; font-size: 13px;">
          <strong>Configura√ß√µes futuras:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Mensagem inicial (/start)</li>
            <li>Mensagens de downsell</li>
            <li>Disparos (shots)</li>
            <li>Configura√ß√£o de m√≠dia</li>
          </ul>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeBotModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar Bot</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Editar Bot -->
  <div id="editBotModal" class="modal">
    <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>Editar Bot</h2>
        <button class="modal-close" onclick="closeEditBotModal()">√ó</button>
      </div>
      <form id="editBotForm" onsubmit="saveEditBotForm(event)">
        <input type="hidden" id="editBotId" name="id">

        <div class="form-group">
          <label for="editBotSlug">Nome/Slug do Bot *</label>
          <input type="text" id="editBotSlug" name="slug" placeholder="ex: vipshadriee_bot" required>
          <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
            Alterar o slug tamb√©m altera o nome do bot (mant√©m sincronizados)
          </small>
        </div>

        <div class="form-group">
          <label for="editBotGateway">Gateway de Pagamento Padr√£o</label>
          <select id="editBotGateway" name="gateway_default">
            <option value="pushinpay">PushinPay</option>
            <option value="syncpay">SyncPay</option>
          </select>
          <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
            Gateway padr√£o para cobran√ßas PIX deste bot
          </small>
        </div>

        <div class="form-group">
          <label for="editBotToken">Token do Bot Telegram</label>
          <div style="display: flex; gap: 8px; align-items: flex-start;">
            <div style="flex: 1;">
              <input 
                type="password" 
                id="editBotToken" 
                name="token" 
                placeholder="ex: 123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefg"
                autocomplete="off"
              >
              <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                üîí Armazenado criptografado. Logs sempre mascaram.
              </small>
            </div>
            <button 
              type="button" 
              class="btn-secondary" 
              id="validateTokenBtn"
              onclick="validateBotToken()"
              style="margin-top: 0; white-space: nowrap;"
            >
              Validar
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>Status do Token</label>
          <div id="tokenStatusBadge" style="padding: 12px; border-radius: 6px; background: #f0f0f0; color: #666; font-size: 13px;">
            N√£o validado
          </div>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="editBotActive" name="active">
            <label for="editBotActive" style="margin: 0;">Ativo</label>
          </div>
          <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
            ‚ö†Ô∏è S√≥ √© poss√≠vel ativar se o token estiver validado
          </small>
        </div>

        <div class="form-group">
          <label for="editBotWarmupChatId">ID do Grupo de Aquecimento (Warmup)</label>
          <input 
            type="text" 
            id="editBotWarmupChatId" 
            name="warmup_chat_id" 
            placeholder="ex: -1001234567890"
          >
          <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
            ID do grupo/chat onde o bot enviar√° m√≠dias para aquecimento e gera√ß√£o de file_id. Deixe vazio para desabilitar warmup.
          </small>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; color: #999; font-size: 13px;">
          <strong>Pr√≥ximas etapas:</strong>
          <p style="margin-top: 10px;">
            Clique em "Configurar" na tabela para acessar as configura√ß√µes completas do bot (mensagens, downsells, shots, m√≠dia).
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeEditBotModal()">Cancelar</button>
          <button type="submit" class="btn-primary" id="saveEditBotBtn">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentBotId = null;
    let showInactive = false;

    // Carregar bots ao iniciar
    document.addEventListener('DOMContentLoaded', () => {
      loadBots(false);
      updateFilterButtons(false);
    });

    async function loadBots(includeInactive = false) {
      showInactive = includeInactive;
      updateFilterButtons(includeInactive);
      const container = document.getElementById('bots-container');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando bots...</p></div>';

      try {
        const url = `/api/admin/bots?includeInactive=${includeInactive}`;
        const response = await fetch(url);
        const result = await response.json();

        if (!result.success) {
          showAlert('Erro ao carregar bots', 'error');
          container.innerHTML = '<div class="empty-state"><p>Erro ao carregar bots</p></div>';
          return;
        }

        const bots = result.data || [];
        document.getElementById('bot-count').textContent = `${bots.length} bot(s)`;

        if (bots.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Nenhum bot registrado</p><p style="font-size: 12px; color: #ccc;">Clique em "Novo Bot" para criar um</p></div>';
          return;
        }

        let html = '<table class="bots-table"><thead><tr><th>Bot</th><th>Status</th><th>Gateway</th><th>Token</th><th>Criado em</th><th>A√ß√µes</th></tr></thead><tbody>';

        bots.forEach(bot => {
          const status = bot.active ? 'Ativo' : 'Inativo';
          const statusBadgeClass = bot.active ? 'badge-success' : 'badge-error';
          const createdAt = new Date(bot.created_at).toLocaleDateString('pt-BR');
          
          // Status do token
          let tokenBadgeClass = 'badge-error'; // default: inv√°lido
          let tokenText = 'N√£o validado';
          let tokenTooltip = 'Token n√£o foi validado ainda';
          
          if (bot.token_status === 'validated') {
            tokenBadgeClass = 'badge-success';
            tokenText = 'Validado';
            tokenTooltip = bot.bot_username ? `@${bot.bot_username} ‚Äî ${bot.bot_name}` : 'Validado';
          } else if (bot.token_status === 'invalid') {
            tokenBadgeClass = 'badge-error';
            tokenText = 'Inv√°lido';
            tokenTooltip = 'Token inv√°lido. Clique em Editar para validar novamente.';
          }

          html += `
            <tr title="${tokenTooltip}">
              <td><span class="bot-name">${bot.name || bot.slug}</span></td>
              <td><span class="badge ${statusBadgeClass}">${status}</span></td>
              <td>${bot.gateway_default || 'pushinpay'}</td>
              <td><span class="badge ${tokenBadgeClass}">${tokenText}</span></td>
              <td>${createdAt}</td>
              <td>
                <div class="bot-actions">
                  <button class="btn-secondary btn-small" onclick="openEditBotModal(${bot.id})">Editar</button>
                  <button class="btn-secondary btn-small" onclick="openConfigureBot(${bot.id})">Config</button>
                  ${bot.token_status === 'validated' && !bot.active
                    ? `<button class="btn-success btn-small" onclick="activateBot(${bot.id})">Ativar</button>`
                    : bot.active
                    ? `<button class="btn-danger btn-small" onclick="deactivateBot(${bot.id})">Pausar</button>`
                    : `<button class="btn-success btn-small" disabled title="Valide o token primeiro">Ativar</button>`
                  }
                </div>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar bots:', error);
        showAlert('Erro ao carregar bots: ' + error.message, 'error');
        container.innerHTML = '<div class="empty-state"><p>Erro ao carregar bots</p></div>';
      }
    }

    function updateFilterButtons(includeInactive) {
      const activeBtn = document.getElementById('filter-active');
      const inactiveBtn = document.getElementById('filter-inactive');

      if (includeInactive) {
        activeBtn.classList.remove('active');
        inactiveBtn.classList.add('active');
      } else {
        activeBtn.classList.add('active');
        inactiveBtn.classList.remove('active');
      }
    }

    function openCreateBotModal() {
      document.getElementById('botForm').reset();
      document.getElementById('botActive').checked = true;
      document.getElementById('modalTitle').textContent = 'Novo Bot';
      document.getElementById('botModal').classList.add('active');
    }

    function closeBotModal() {
      document.getElementById('botModal').classList.remove('active');
    }

    async function saveBotForm(event) {
      event.preventDefault();

      const slug = document.getElementById('botSlug').value.trim();
      const provider = document.getElementById('botProvider').value;
      const active = document.getElementById('botActive').checked;

      if (!slug) {
        showAlert('Nome/Slug do bot √© obrigat√≥rio', 'error');
        return;
      }

      try {
        const response = await fetch('/api/admin/bots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, provider, active })
        });

        const result = await response.json();

        if (!result.success) {
          showAlert(result.error || 'Erro ao criar bot', 'error');
          return;
        }

        showAlert('Bot criado com sucesso!', 'success');
        closeBotModal();
        loadBots(showInactive);
      } catch (error) {
        console.error('Erro ao criar bot:', error);
        showAlert('Erro ao criar bot: ' + error.message, 'error');
      }
    }

    async function openEditBotModal(botId) {
      try {
        const response = await fetch(`/api/admin/bots/${botId}`);
        const result = await response.json();

        if (!result.success) {
          showAlert('Erro ao carregar bot', 'error');
          return;
        }

        const bot = result.data;
        currentBotId = botId;

        document.getElementById('editBotId').value = botId;
        document.getElementById('editBotSlug').value = bot.slug;
        document.getElementById('editBotGateway').value = bot.gateway_default || 'pushinpay';
        document.getElementById('editBotToken').value = ''; // Nunca preencher token (seguran√ßa)
        document.getElementById('editBotActive').checked = bot.active;
        document.getElementById('editBotWarmupChatId').value = bot.warmup_chat_id || '';

        // Atualizar badge de status do token
        updateTokenStatusBadge(bot.token_status, bot.bot_username, bot.bot_name);

        document.getElementById('editBotModal').classList.add('active');
      } catch (error) {
        console.error('Erro ao carregar bot:', error);
        showAlert('Erro ao carregar bot: ' + error.message, 'error');
      }
    }

    function updateTokenStatusBadge(status, username, name) {
      const badge = document.getElementById('tokenStatusBadge');
      const activeCheckbox = document.getElementById('editBotActive');
      
      if (status === 'validated') {
        badge.style.background = '#d4edda';
        badge.style.color = '#155724';
        badge.textContent = `‚úì Validado: @${username} ‚Äî ${name}`;
        activeCheckbox.disabled = false;
      } else if (status === 'invalid') {
        badge.style.background = '#f8d7da';
        badge.style.color = '#721c24';
        badge.textContent = '‚úó Inv√°lido (toque em Validar)';
        activeCheckbox.disabled = true;
        activeCheckbox.checked = false;
      } else {
        badge.style.background = '#f0f0f0';
        badge.style.color = '#666';
        badge.textContent = 'N√£o validado';
        activeCheckbox.disabled = true;
        activeCheckbox.checked = false;
      }
    }

    async function validateBotToken() {
      const botId = document.getElementById('editBotId').value;
      const token = document.getElementById('editBotToken').value.trim();

      if (!token) {
        showAlert('Digite o token do bot', 'error');
        return;
      }

      const validateBtn = document.getElementById('validateTokenBtn');
      const originalText = validateBtn.textContent;
      validateBtn.textContent = 'Carregando‚Ä¶';
      validateBtn.disabled = true;

      try {
        const response = await fetch(`/api/admin/bots/${botId}/validate-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        const result = await response.json();

        if (result.success && result.data.ok) {
          showAlert(`Token validado: @${result.data.username}`, 'success');
          updateTokenStatusBadge('validated', result.data.username, result.data.name);
        } else {
          const errorMsg = result.data?.message || result.error || 'Erro ao validar token';
          showAlert(`Erro: ${errorMsg}`, 'error');
          updateTokenStatusBadge('invalid', null, null);
        }
      } catch (error) {
        console.error('Erro ao validar token:', error);
        showAlert('Erro ao validar token: ' + error.message, 'error');
      } finally {
        validateBtn.textContent = originalText;
        validateBtn.disabled = false;
      }
    }

    function closeEditBotModal() {
      document.getElementById('editBotModal').classList.remove('active');
      currentBotId = null;
    }

    async function saveEditBotForm(event) {
      event.preventDefault();

      const botId = document.getElementById('editBotId').value;
      const slug = document.getElementById('editBotSlug').value.trim();
      const gateway_default = document.getElementById('editBotGateway').value;
      const active = document.getElementById('editBotActive').checked;
      const warmup_chat_id_str = document.getElementById('editBotWarmupChatId').value.trim();
      
      // Converter warmup_chat_id para n√∫mero ou null
      let warmup_chat_id = null;
      if (warmup_chat_id_str) {
        warmup_chat_id = parseInt(warmup_chat_id_str, 10);
        if (isNaN(warmup_chat_id)) {
          showAlert('ID do grupo de aquecimento deve ser um n√∫mero v√°lido', 'error');
          return;
        }
      }

      if (!slug) {
        showAlert('Nome/Slug do bot √© obrigat√≥rio', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/admin/bots/${botId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug, gateway_default, active, warmup_chat_id })
        });

        const result = await response.json();

        if (!result.success) {
          showAlert(result.error || 'Erro ao atualizar bot', 'error');
          return;
        }

        showAlert('Bot atualizado com sucesso!', 'success');
        closeEditBotModal();
        loadBots(showInactive);
      } catch (error) {
        console.error('Erro ao atualizar bot:', error);
        showAlert('Erro ao atualizar bot: ' + error.message, 'error');
      }
    }

    async function deactivateBot(botId) {
      if (!confirm('Tem certeza que deseja pausar este bot?')) return;

      try {
        const response = await fetch(`/api/admin/bots/${botId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (!result.success) {
          showAlert(result.error || 'Erro ao pausar bot', 'error');
          console.error('[DEACTIVATE_BOT] Erro na API:', result.error);
          return;
        }

        console.log('[DEACTIVATE_BOT] Bot pausado com sucesso:', result.data);
        showAlert('Bot pausado com sucesso!', 'success');
        await loadBots(showInactive);
      } catch (error) {
        console.error('[DEACTIVATE_BOT] Erro ao pausar bot:', error);
        showAlert('Erro ao pausar bot: ' + error.message, 'error');
      }
    }

    async function activateBot(botId) {
      try {
        const response = await fetch(`/api/admin/bots/${botId}/activate`, {
          method: 'POST'
        });

        const result = await response.json();

        if (!result.success) {
          showAlert(result.error || 'Erro ao ativar bot', 'error');
          console.error('[ACTIVATE_BOT] Erro na API:', result.error);
          return;
        }

        console.log('[ACTIVATE_BOT] Bot ativado com sucesso:', result.data);
        showAlert('Bot ativado com sucesso!', 'success');
        await loadBots(showInactive);
      } catch (error) {
        console.error('[ACTIVATE_BOT] Erro ao ativar bot:', error);
        showAlert('Erro ao ativar bot: ' + error.message, 'error');
      }
    }

    function openConfigureBot(botId) {
      // Abrir p√°gina de configura√ß√£o do bot em nova aba
      window.open(`/admin-bot-config.html?botId=${botId}`, '_blank');
    }

    function showAlert(message, type = 'success') {
      const alertsContainer = document.getElementById('alerts');
      const alertId = 'alert-' + Date.now();

      const alertHtml = `
        <div class="alert alert-${type}" id="${alertId}">
          <span>${message}</span>
          <button class="alert-close" onclick="document.getElementById('${alertId}').remove()">√ó</button>
        </div>
      `;

      alertsContainer.innerHTML += alertHtml;

      // Auto-remover ap√≥s 5 segundos
      setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) alert.remove();
      }, 5000);
    }
  </script>
</body>
</html>
